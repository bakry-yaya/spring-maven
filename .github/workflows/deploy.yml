name: Spring Boot CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  [cite_start]workflow_dispatch: # Permet de lancer le build manuellement [cite: 391, 392, 393]

jobs:
  build:
    name: Build, Test, Sonar & Nexus
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        [cite_start]uses: actions/checkout@v4 [cite: 403, 404]

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          [cite_start]cache: maven [cite: 406, 407, 408, 409, 410, 411]

      - name: Build with Maven
        [cite_start]run: mvn clean verify [cite: 413, 414]

      - name: SonarQube Analysis
        run: |
          mvn sonar:sonar \
          -Dsonar.projectKey=bakry-yaya_spring-maven \
          -Dsonar.organization=bakry-yaya \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} 

      - name: Publish to Nexus
        if: github.ref == 'refs/heads/main'
        run: mvn deploy -DskipTests
        env:
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          [cite_start]NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }} [cite: 425, 426, 427, 428, 429, 430]

      # Ã‰tape cruciale pour que le job Docker fonctionne [cite: 431, 432]
      - name: Upload JAR artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: springboot-jar
          [cite_start]path: target/*.jar [cite: 434, 435, 436, 437]

  docker:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        [cite_start]uses: actions/checkout@v4 [cite: 444, 445]

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: springboot-jar
          [cite_start]path: target [cite: 446, 447, 448, 449, 450]

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          [cite_start]password: ${{ secrets.DOCKERHUB_TOKEN }} [cite: 451, 452, 453, 454, 455]

      - name: Build & Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:latest .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:latest [cite: 456, 457, 458, 459]
